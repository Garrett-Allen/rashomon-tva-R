---
title: "rashomon_package"
author: "garrett-allen"
format: html
editor: visual
---

```{r}
library(rashomontva)
library(tidyverse)
library(collections)
library(data.table)
```

#todo add examples

```{r}

#M = 2
#R = c(3,4)

data <- data.frame(arm1 = c(1,1,1,1,1,1,1,1,1,2,2,3,3,3,2,2,2,2,2,2,3,3,3,3,3,3,3), 
                    arm2 = c(1,2,3,1,2,3,1,2,3,1,2,3,1,2,4,1,2,3,1,2,3,4,2,4,1,2,4), 
                    value = runif(27))
sigma <- initialize_sigma(2, c(5,5))

data <- assign_policy_label(data,arm1,arm2)

policy_list <- create_policies_from_data(data, arm1, arm2)

edge_list <- lattice_edges(sigma, policy_list)

M <- policy_means(data, value)

# use as.integer


```



```{r}

data <- read.csv('output.csv') %>% 
  rename(arm1 = 'X0',
         arm2 = 'X1',
         arm3 = 'X2',
         id = 'X',
         observation = 'Y') %>% 
  select(-D)

M = 3
R = c(4,3,3)
H = Inf
theta = 13
lamb = 1

rset <- aggregate_rashomon_profiles(data, 
                            arm1,
                            arm2,
                            arm3, 
                            M = M, 
                            H = H, 
                            R = R, 
                            reg = lamb, 
                            value = observation, 
                            theta = theta)

# TODO: Make predictions from this output
# TODO: Test
# TODO: Deal with ids in a smart way
#' @export
make_rashomon_objects <- function(rset){

  rash_models = list()
  for(x in rset[[1]]){
    rashomon_i = RashomonSet(models = list(),
                             losses = numeric(),
                             pools = list(),
                             profiles = list())
    for(i in 1:length(rset[[2]])){
      model_i = rset[[2]][[i]]$models[[x[[i]]]]
      loss_i = rset[[2]][[i]]$losses[[x[[i]]]]
      pools_i = rset[[2]][[i]]$pools[[x[[i]]]]
      profiles_i = rset[[2]][[i]]$profiles[[x[[i]]]]

      rashomon_i$insert_model(model_i, loss_i, pools_i, list(profiles_i))
    }
    rash_models = append(rash_models, rashomon_i)
  }
  rash_models
}

#' @export
models <- make_rashomon_objects(rset)

compute_loss <- function(model){
  sum(model$losses)
}

predict <- function(model)




```

```{r}
```

```{r}
data.frame(spp1 = c("plant_1","plant_3"),
           cc1 = c("p","r"),
           spp2 = c("plant_2","plant_4"),
           cc2 = c("p","r")) %>% 
  mutate(id = 1:n())  
```

